<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAMLAC - Interface Agents</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .main-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .btn-secondary {
            background: #17a2b8;
            margin-top: 10px;
            padding: 8px;
            font-size: 12px;
        }
        
        .btn-secondary:hover {
            background: #138496;
        }
        
        .utility-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .utility-buttons button {
            flex: 1;
            padding: 10px;
            font-size: 11px;
            border-radius: 6px;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-sync {
            background: #17a2b8;
        }
        
        .btn-clean {
            background: #6c757d;
        }
        
        .btn-reload {
            background: #fd7e14;
        }
        
        .btn-stats {
            background: #e83e8c;
        }
        
        .stock-info {
            background: #e8f4f8;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .main-card {
                padding: 20px;
            }
            
            .utility-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üì¶ KAMLAC - Interface Agents</h1>
            <p>Gestion des Mouvements de Stock</p>
        </div>
        
        <!-- Main Interface -->
        <div class="main-card">
            <h2 style="color: #667eea; margin-bottom: 25px; text-align: center;">üîÑ Enregistrement des Op√©rations</h2>
            
            <!-- Alert Container -->
            <div id="alertContainer"></div>
            
            <!-- Formulaire Production -->
            <form id="productionForm">
                <div class="form-group">
                    <label for="prodProduitSelect">üì¶ Produit :</label>
                    <select id="prodProduitSelect" onchange="handleProductSelection()">
                        <option value="">üîç Chargement des produits...</option>
                    </select>
                    
                    <!-- Bouton de rechargement des produits -->
                    <button type="button" onclick="chargerProduitsDisponibles()" class="btn-secondary" style="margin-top: 10px;" title="Recharger la liste des produits">
                        üîÑ Recharger la liste des produits
                    </button>
                    
                    <input type="text" id="prodProduit" placeholder="‚úèÔ∏è Saisir le nom du nouveau produit" class="hidden">
                </div>
                
                <!-- Informations sur le stock actuel -->
                <div id="stockInfoDisplay" class="stock-info">
                    <span id="stockInfoText">üìä Stock actuel: <strong>0 unit√©s</strong></span>
                </div>
                
                <div class="form-group">
                    <label for="prodQuantite">üìä Quantit√© :</label>
                    <input type="number" id="prodQuantite" placeholder="0" min="1" required>
                </div>
                
                <div class="form-group">
                    <label for="prodDate">üìÖ Date :</label>
                    <input type="date" id="prodDate" required>
                </div>
                
                <div class="form-group">
                    <label for="prodType">üìù Type d'op√©ration :</label>
                    <select id="prodType" required>
                        <option value="reception_mp">üì• R√©ception Mati√®re Premi√®re</option>
                        <option value="reception_pf">üì¶ R√©ception Produit Fini</option>
                        <option value="sortie_mp">üì§ Sortie Mati√®re Premi√®re</option>
                        <option value="sortie_pf">üöö Sortie Produit Fini</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="prodAgent">üë§ Agent :</label>
                    <input type="text" id="prodAgent" placeholder="Nom de l'agent" required>
                </div>
                
                <div class="form-group">
                    <label for="prodCommentaire">üìù Commentaire :</label>
                    <textarea id="prodCommentaire" placeholder="D√©tails de l'op√©ration..." rows="3"></textarea>
                </div>
                
                <button type="submit" class="btn">
                    ‚úÖ Enregistrer Op√©ration
                </button>
            </form>
            

        </div>
        
        <!-- Statistiques -->
        <div id="statsContainer" class="main-card hidden">
            <h3 style="color: #667eea; margin-bottom: 20px; text-align: center;">üìä Statistiques du Jour</h3>
            <div id="statsGrid" class="stats-grid">
                <!-- Rempli dynamiquement -->
            </div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, query, where, orderBy, limit, enableNetwork, disableNetwork } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDSQ0cQa7TIcBJGwmh5-BdaNaVgPFnLGGc",
            authDomain: "kamlac-6b8ed.firebaseapp.com",
            projectId: "kamlac-6b8ed",
            storageBucket: "kamlac-6b8ed.firebasestorage.app",
            messagingSenderId: "707925227562",
            appId: "1:707925227562:web:a7b8b10c63ecf359da8b18",
            measurementId: "G-59LPWQ2M9J"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // √âtat de connexion Firebase
        let isFirebaseReady = false;
        let isOnline = true;

        // Test de connexion Firebase
        async function testFirebaseConnection() {
            console.log('üîÑ Test de connexion Firebase...');
            
            // D√©marrer directement en mode offline par d√©faut
            isFirebaseReady = false;
            isOnline = false;
            
            try {
                // Test rapide avec timeout tr√®s court
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Connection timeout')), 2000);
                });
                
                const testPromise = getDocs(query(collection(db, 'test'), limit(1)));
                
                await Promise.race([testPromise, timeoutPromise]);
                
                // Si on arrive ici, Firebase fonctionne
                isFirebaseReady = true;
                isOnline = true;
                console.log('‚úÖ Firebase connect√© et pr√™t');
                showAlert('‚úÖ Connexion Firebase r√©ussie - Synchronisation activ√©e', 'success');
                
            } catch (error) {
                console.log('üì¥ Firebase indisponible - Mode offline permanent');
                isFirebaseReady = false;
                isOnline = false;
                
                // Forcer le mode offline
                try {
                    await disableNetwork(db);
                } catch (offlineError) {
                    // Ignorer les erreurs de d√©sactivation
                }
                
                showAlert('ÔøΩ Mode offline - Toutes les donn√©es sont sauv√©es localement', 'warning');
            }
        }

        // Initialiser la connexion
        console.log('üöÄ Initialisation Firebase...');
        testFirebaseConnection().catch(error => {
            console.log('üö® Erreur initialisation Firebase, mode offline forc√©');
            isFirebaseReady = false;
            isOnline = false;
            showAlert('üì¥ Mode offline - Application pr√™te', 'warning');
        });

        // Exposer les fonctions Firebase globalement
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.deleteDoc = deleteDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.limit = limit;
        window.isFirebaseReady = () => isFirebaseReady;
        window.isOnline = () => isOnline;

        // Variables globales
        window.stockEntriesData = [];
        window.stockExitsData = [];
        window.currentStockLevels = {};
        window.salesData = [];

        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Interface Agents KAMLAC initialis√©e');
            
            // D√©finir la date actuelle
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('prodDate').value = today;
            
            // Charger les donn√©es initiales
            chargerDonneesInitiales();
            
            // G√©rer la soumission du formulaire
            document.getElementById('productionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                enregistrerProduction();
            });
        });

        // Charger les donn√©es initiales
        async function chargerDonneesInitiales() {
            try {
                showAlert('üîÑ Chargement des donn√©es...', 'info');
                
                await Promise.all([
                    chargerProduitsDisponibles(),
                    loadStockData(),
                    loadSalesData()
                ]);
                
                hideAlert();
                console.log('‚úÖ Donn√©es initiales charg√©es');
            } catch (error) {
                console.error('‚ùå Erreur chargement initial:', error);
                showAlert('‚ùå Erreur lors du chargement des donn√©es', 'error');
            }
        }

        // Exposer les fonctions principales
        window.chargerDonneesInitiales = chargerDonneesInitiales;
    </script>

    <script>
        // =====================================================
        // FONCTIONS PRINCIPALES MODULE 3
        // =====================================================

        // Charger les produits disponibles
        async function chargerProduitsDisponibles() {
            console.log('üîÑ Chargement de la liste des produits...');
            
            const selectElement = document.getElementById('prodProduitSelect');
            selectElement.innerHTML = '<option value="">üîÑ Chargement...</option>';
            
            try {
                const products = new Set();
                
                // Charger depuis Firebase SEULEMENT si connect√©
                if (isOnline && isFirebaseReady) {
                    try {
                        const productsSnapshot = await getDocs(collection(db, 'products'));
                        productsSnapshot.forEach(doc => {
                            const productData = doc.data();
                            if (productData.name && productData.name.trim()) {
                                products.add(productData.name.trim());
                            }
                        });
                        console.log('‚úÖ Produits charg√©s depuis Firebase');
                    } catch (firebaseError) {
                        console.log('‚ùå Erreur chargement Firebase produits:', firebaseError.message);
                    }
                }
                
                // Ajouter depuis les donn√©es locales
                if (window.salesData && window.salesData.length > 0) {
                    window.salesData.forEach(sale => {
                        if (sale.product && sale.product.trim()) {
                            products.add(sale.product.trim());
                        }
                    });
                }
                
                if (window.stockEntriesData && window.stockEntriesData.length > 0) {
                    window.stockEntriesData.forEach(entry => {
                        if (entry.product && entry.product.trim()) {
                            products.add(entry.product.trim());
                        }
                    });
                }
                
                if (window.stockExitsData && window.stockExitsData.length > 0) {
                    window.stockExitsData.forEach(exit => {
                        if (exit.product && exit.product.trim()) {
                            products.add(exit.product.trim());
                        }
                    });
                }
                
                // Ajouter depuis les productions locales
                const productions = JSON.parse(localStorage.getItem('productions') || '[]');
                productions.forEach(prod => {
                    if (prod.produit && prod.produit.trim()) {
                        products.add(prod.produit.trim());
                    }
                });
                
                // Remplir le select
                selectElement.innerHTML = '<option value="">üîç S√©lectionner un produit existant</option>';
                
                const sortedProducts = Array.from(products).sort();
                sortedProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product;
                    option.textContent = product;
                    selectElement.appendChild(option);
                });
                
                // Option pour nouveau produit
                const newOption = document.createElement('option');
                newOption.value = 'NOUVEAU';
                newOption.textContent = '‚ûï Ajouter un nouveau produit';
                selectElement.appendChild(newOption);
                
                console.log(`‚úÖ ${sortedProducts.length} produits charg√©s`);
                
            } catch (error) {
                console.error('‚ùå Erreur chargement produits:', error);
                selectElement.innerHTML = '<option value="">‚ùå Erreur de chargement</option>';
                showAlert('‚ùå Erreur lors du chargement des produits', 'error');
            }
        }

        // G√©rer la s√©lection de produit
        function handleProductSelection() {
            const selectElement = document.getElementById('prodProduitSelect');
            const inputElement = document.getElementById('prodProduit');
            const stockInfoDisplay = document.getElementById('stockInfoDisplay');
            const stockInfoText = document.getElementById('stockInfoText');
            
            if (selectElement.value === 'NOUVEAU') {
                inputElement.classList.remove('hidden');
                inputElement.focus();
                stockInfoDisplay.style.display = 'none';
            } else if (selectElement.value) {
                inputElement.classList.add('hidden');
                inputElement.value = '';
                
                // Afficher le stock actuel
                const currentStock = window.currentStockLevels[selectElement.value];
                if (currentStock) {
                    const quantity = currentStock.quantity || 0;
                    const unit = currentStock.unit || 'Unit√©s';
                    stockInfoText.innerHTML = `üìä Stock actuel: <strong>${quantity.toLocaleString()} ${unit}</strong>`;
                    stockInfoDisplay.style.display = 'block';
                } else {
                    stockInfoText.innerHTML = `üìä Stock actuel: <strong>0 Unit√©s</strong> (Nouveau produit)`;
                    stockInfoDisplay.style.display = 'block';
                }
            } else {
                inputElement.classList.add('hidden');
                stockInfoDisplay.style.display = 'none';
            }
        }

        // Enregistrer une production
        async function enregistrerProduction() {
            console.log('üîÑ D√©but enregistrement production...');
            
            const selectProduit = document.getElementById('prodProduitSelect');
            const inputProduit = document.getElementById('prodProduit');
            const quantite = document.getElementById('prodQuantite');
            const date = document.getElementById('prodDate');
            const type = document.getElementById('prodType');
            const agent = document.getElementById('prodAgent');
            const commentaire = document.getElementById('prodCommentaire');
            
            // Validation
            let produitFinal = '';
            if (selectProduit.value === 'NOUVEAU') {
                if (!inputProduit.value.trim()) {
                    showAlert('‚ùå Veuillez saisir le nom du nouveau produit', 'error');
                    inputProduit.focus();
                    return;
                }
                produitFinal = inputProduit.value.trim();
            } else if (selectProduit.value) {
                produitFinal = selectProduit.value;
            } else {
                showAlert('‚ùå Veuillez s√©lectionner un produit', 'error');
                selectProduit.focus();
                return;
            }
            
            if (!quantite.value || quantite.value <= 0) {
                showAlert('‚ùå Veuillez saisir une quantit√© valide', 'error');
                quantite.focus();
                return;
            }
            
            if (!date.value) {
                showAlert('‚ùå Veuillez s√©lectionner une date', 'error');
                date.focus();
                return;
            }
            
            if (!agent.value.trim()) {
                showAlert('‚ùå Veuillez saisir le nom de l\'agent', 'error');
                agent.focus();
                return;
            }
            
            // Cr√©er l'objet production
            const production = {
                id: 'prod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                produit: produitFinal,
                quantite: parseFloat(quantite.value),
                date: date.value,
                type: type.value,
                agent: agent.value.trim(),
                commentaire: commentaire.value.trim(),
                timestamp: new Date().toISOString()
            };
            
            console.log('üì¶ Donn√©es production:', production);
            
            try {
                // TOUJOURS sauvegarder en localStorage EN PREMIER
                let productions = JSON.parse(localStorage.getItem('productions') || '[]');
                productions.push(production);
                localStorage.setItem('productions', JSON.stringify(productions));
                console.log('‚úÖ Production sauv√©e en localStorage');
                
                // Int√©grer dans les stocks IMM√âDIATEMENT
                const isEntry = production.type.includes('reception');
                await integrerDansStock(production, isEntry);
                console.log('‚úÖ Stock mis √† jour');
                
                // R√©initialiser le formulaire IMM√âDIATEMENT
                resetForm();
                console.log('‚úÖ Formulaire r√©initialis√©');
                
                // Tentative de sauvegarde Firebase (sans bloquer)
                if (isOnline && isFirebaseReady) {
                    try {
                        await addDoc(collection(db, 'productions'), production);
                        console.log('‚úÖ Production synchronis√©e sur Firebase');
                        showAlert(`‚úÖ Op√©ration enregistr√©e et synchronis√©e: ${produitFinal}`, 'success');
                    } catch (firebaseError) {
                        console.log('‚ùå √âchec synchronisation Firebase:', firebaseError.message);
                        showAlert(`‚úÖ Op√©ration enregistr√©e localement: ${produitFinal} (Sync √©chou√©e)`, 'success');
                    }
                } else {
                    console.log('üì¥ Mode offline - pas de tentative Firebase');
                    showAlert(`‚úÖ Op√©ration enregistr√©e: ${produitFinal} (Mode offline)`, 'success');
                }
                
                // Recharger la liste des produits
                setTimeout(() => {
                    chargerProduitsDisponibles();
                }, 500);
                
            } catch (error) {
                console.error('‚ùå ERREUR CRITIQUE enregistrement:', error);
                showAlert('‚ùå Erreur lors de l\'enregistrement de l\'op√©ration', 'error');
            }
        }

        // Int√©grer dans le stock
        async function integrerDansStock(production, isEntry) {
            console.log('üì¶ INT√âGRATION STOCK', {
                produit: production.produit,
                quantite: production.quantite,
                type: production.type,
                isEntry: isEntry
            });
            
            try {
                const stockData = {
                    id: production.id + '_stock',
                    product: production.produit,
                    quantity: production.quantite,
                    unit: 'Cartons',
                    date: production.date,
                    agent: production.agent,
                    reference: `Module3_${production.type}_${production.id}`,
                    timestamp: production.timestamp
                };
                
                if (isEntry) {
                    console.log('üì• TRAITEMENT COMME ENTR√âE DE STOCK');
                    
                    const stockEntryData = {
                        ...stockData,
                        type: mapProductionTypeToStockType(production.type, true),
                        supplier: production.agent,
                        unitCost: 0,
                        totalCost: 0
                    };
                    
                    // Sauvegarder localement
                    let stockEntries = JSON.parse(localStorage.getItem('stockEntries') || '[]');
                    stockEntries.push(stockEntryData);
                    localStorage.setItem('stockEntries', JSON.stringify(stockEntries));
                    window.stockEntriesData = stockEntries;
                    console.log('‚úÖ Entr√©e stock sauv√©e localement');
                    
                    // Sauvegarder sur Firebase (si connect√©)
                    if (isOnline && isFirebaseReady) {
                        try {
                            await addDoc(collection(db, 'stockEntries'), stockEntryData);
                            console.log('‚úÖ Entr√©e stock synchronis√©e Firebase');
                        } catch (firebaseError) {
                            console.log('‚ùå √âchec sync Firebase stockEntries:', firebaseError.message);
                        }
                    }
                    
                } else {
                    console.log('üì§ TRAITEMENT COMME SORTIE DE STOCK');
                    
                    const stockExitData = {
                        ...stockData,
                        type: mapProductionTypeToStockType(production.type, false),
                        destination: 'Production',
                        unitCost: 0,
                        totalCost: 0
                    };
                    
                    // Sauvegarder localement
                    let stockExits = JSON.parse(localStorage.getItem('stockExits') || '[]');
                    stockExits.push(stockExitData);
                    localStorage.setItem('stockExits', JSON.stringify(stockExits));
                    window.stockExitsData = stockExits;
                    console.log('‚úÖ Sortie stock sauv√©e localement');
                    
                    // Sauvegarder sur Firebase (si connect√©)
                    if (isOnline && isFirebaseReady) {
                        try {
                            await addDoc(collection(db, 'stockExits'), stockExitData);
                            console.log('‚úÖ Sortie stock synchronis√©e Firebase');
                        } catch (firebaseError) {
                            console.log('‚ùå √âchec sync Firebase stockExits:', firebaseError.message);
                        }
                    }
                }
                
                // Recalculer les niveaux de stock
                calculateStockLevels();
                console.log('‚úÖ Int√©gration stock termin√©e');
                
            } catch (error) {
                console.error('‚ùå Erreur int√©gration stock:', error);
                throw error; // Propager l'erreur
            }
        }

        // Mapper les types de production vers les types de stock
        function mapProductionTypeToStockType(productionType, isEntry) {
            const typeMap = {
                'reception_mp': isEntry ? 'R√©ception MP' : 'Sortie MP',
                'reception_pf': isEntry ? 'R√©ception PF' : 'Sortie PF',
                'sortie_mp': isEntry ? 'Entr√©e MP' : 'Utilisation MP',
                'sortie_pf': isEntry ? 'Entr√©e PF' : 'Exp√©dition PF'
            };
            
            return typeMap[productionType] || (isEntry ? 'Entr√©e' : 'Sortie');
        }

        // R√©initialiser le formulaire
        function resetForm() {
            document.getElementById('productionForm').reset();
            document.getElementById('prodProduit').classList.add('hidden');
            document.getElementById('stockInfoDisplay').style.display = 'none';
            
            // Remettre la date actuelle
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('prodDate').value = today;
        }

        // =====================================================
        // FONCTIONS DE SUPPORT
        // =====================================================

        // Charger les donn√©es de stock
        async function loadStockData() {
            try {
                window.stockEntriesData = JSON.parse(localStorage.getItem('stockEntries') || '[]');
                window.stockExitsData = JSON.parse(localStorage.getItem('stockExits') || '[]');
                calculateStockLevels();
            } catch (error) {
                console.error('‚ùå Erreur chargement stock:', error);
            }
        }

        // Charger les donn√©es de ventes
        async function loadSalesData() {
            try {
                window.salesData = JSON.parse(localStorage.getItem('salesData') || '[]');
            } catch (error) {
                console.error('‚ùå Erreur chargement ventes:', error);
            }
        }

        // Calculer les niveaux de stock
        function calculateStockLevels() {
            window.currentStockLevels = {};
            
            // Ajouter les entr√©es
            window.stockEntriesData.forEach(entry => {
                if (!window.currentStockLevels[entry.product]) {
                    window.currentStockLevels[entry.product] = {
                        quantity: 0,
                        unit: entry.unit || 'Unit√©s',
                        value: 0
                    };
                }
                window.currentStockLevels[entry.product].quantity += parseFloat(entry.quantity) || 0;
            });
            
            // Soustraire les sorties
            window.stockExitsData.forEach(exit => {
                if (!window.currentStockLevels[exit.product]) {
                    window.currentStockLevels[exit.product] = {
                        quantity: 0,
                        unit: exit.unit || 'Unit√©s',
                        value: 0
                    };
                }
                window.currentStockLevels[exit.product].quantity -= parseFloat(exit.quantity) || 0;
            });
            
            // Soustraire les ventes
            window.salesData.forEach(sale => {
                if (!window.currentStockLevels[sale.product]) {
                    window.currentStockLevels[sale.product] = {
                        quantity: 0,
                        unit: 'Unit√©s',
                        value: 0
                    };
                }
                window.currentStockLevels[sale.product].quantity -= parseFloat(sale.quantity) || 0;
            });
        }

        // Synchroniser avec Firebase
        async function synchroniserStocksFirebase() {
            showAlert('üîÑ Synchronisation en cours...', 'info');
            
            try {
                // Ici vous pouvez ajouter la logique de synchronisation Firebase
                // Pour l'instant, on simule juste une synchronisation
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                showAlert('‚úÖ Synchronisation termin√©e', 'success');
            } catch (error) {
                console.error('‚ùå Erreur synchronisation:', error);
                showAlert('‚ùå Erreur lors de la synchronisation', 'error');
            }
        }

        // Nettoyer les doublons
        function nettoyerDoublonsStock() {
            showAlert('üßπ Nettoyage en cours...', 'info');
            
            try {
                // Nettoyer les productions
                let productions = JSON.parse(localStorage.getItem('productions') || '[]');
                const uniqueProductions = productions.filter((prod, index, arr) => 
                    arr.findIndex(p => p.id === prod.id) === index
                );
                localStorage.setItem('productions', JSON.stringify(uniqueProductions));
                
                const removed = productions.length - uniqueProductions.length;
                if (removed > 0) {
                    showAlert(`‚úÖ ${removed} doublons supprim√©s`, 'success');
                } else {
                    showAlert('‚úÖ Aucun doublon trouv√©', 'success');
                }
            } catch (error) {
                console.error('‚ùå Erreur nettoyage:', error);
                showAlert('‚ùå Erreur lors du nettoyage', 'error');
            }
        }

        // Recharger les donn√©es
        async function rechargerDonneesStock() {
            showAlert('‚ôªÔ∏è Rechargement en cours...', 'info');
            
            try {
                await chargerDonneesInitiales();
                showAlert('‚úÖ Donn√©es recharg√©es', 'success');
            } catch (error) {
                console.error('‚ùå Erreur rechargement:', error);
                showAlert('‚ùå Erreur lors du rechargement', 'error');
            }
        }

        // Afficher les statistiques
        function afficherStatistiques() {
            const statsContainer = document.getElementById('statsContainer');
            const statsGrid = document.getElementById('statsGrid');
            
            if (statsContainer.classList.contains('hidden')) {
                // Calculer les statistiques du jour
                const today = new Date().toISOString().split('T')[0];
                const productions = JSON.parse(localStorage.getItem('productions') || '[]');
                
                const todayProductions = productions.filter(p => p.date === today);
                const receptions = todayProductions.filter(p => p.type.includes('reception'));
                const sorties = todayProductions.filter(p => p.type.includes('sortie'));
                
                const totalReceptions = receptions.reduce((sum, p) => sum + parseFloat(p.quantite), 0);
                const totalSorties = sorties.reduce((sum, p) => sum + parseFloat(p.quantite), 0);
                
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${todayProductions.length}</div>
                        <div class="stat-label">Op√©rations du jour</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${receptions.length}</div>
                        <div class="stat-label">R√©ceptions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${sorties.length}</div>
                        <div class="stat-label">Sorties</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalReceptions.toLocaleString()}</div>
                        <div class="stat-label">Quantit√© re√ßue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalSorties.toLocaleString()}</div>
                        <div class="stat-label">Quantit√© sortie</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${Object.keys(window.currentStockLevels).length}</div>
                        <div class="stat-label">Produits en stock</div>
                    </div>
                `;
                
                statsContainer.classList.remove('hidden');
            } else {
                statsContainer.classList.add('hidden');
            }
        }

        // =====================================================
        // FONCTIONS UTILITAIRES
        // =====================================================

        // Afficher une alerte
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertClass = `alert-${type === 'info' ? 'warning' : type}`;
            
            alertContainer.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                </div>
            `;
            
            if (type === 'success') {
                setTimeout(hideAlert, 3000);
            }
        }

        // Masquer l'alerte
        function hideAlert() {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = '';
        }

        // Exposer les fonctions n√©cessaires
        window.chargerProduitsDisponibles = chargerProduitsDisponibles;
        window.handleProductSelection = handleProductSelection;
        window.enregistrerProduction = enregistrerProduction;
        window.synchroniserStocksFirebase = synchroniserStocksFirebase;
        window.nettoyerDoublonsStock = nettoyerDoublonsStock;
        window.rechargerDonneesStock = rechargerDonneesStock;
        window.afficherStatistiques = afficherStatistiques;
        window.loadStockData = loadStockData;
        window.loadSalesData = loadSalesData;
        window.calculateStockLevels = calculateStockLevels;
        window.showAlert = showAlert;
        window.hideAlert = hideAlert;
    </script>
</body>
</html>
