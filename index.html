<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“Š KAMLAC Dashboard - Suivi des Ventes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        /* (Votre CSS existant) */
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- (Votre HTML existant) -->
    </div>

    <script>
        // Variables globales
        let salesData = [];
        let filteredData = [];
        let charts = {};
        let salesDetailOffset = 0;
        const salesDetailLimit = 50;
        let db;
        let isFirebaseInitialized = false;

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "VOTRE_API_KEY",
            authDomain: "VOTRE_AUTH_DOMAIN",
            projectId: "VOTRE_PROJECT_ID",
            storageBucket: "VOTRE_STORAGE_BUCKET",
            messagingSenderId: "VOTRE_MESSAGING_SENDER_ID",
            appId: "VOTRE_APP_ID"
        };

        // Initialiser Firebase
        function initializeFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                isFirebaseInitialized = true;
                console.log("Firebase initialisÃ© avec succÃ¨s");
                setupRealtimeListener();
            } catch (error) {
                console.error("Erreur d'initialisation Firebase:", error);
            }
        }

        // Ã‰couteur en temps rÃ©el pour la collection 'sales'
        function setupRealtimeListener() {
            db.collection("sales").onSnapshot((querySnapshot) => {
                salesData = [];
                querySnapshot.forEach((doc) => {
                    salesData.push({ id: doc.id, ...doc.data() });
                });
                saveToLocalStorage();
                populateFilters();
                applyFilters();
                updateDataTable();
                updateDataStats();
            });
        }

        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            initializeFirebase(); // Initialiser Firebase au dÃ©marrage
        });

        function initializeApp() {
            console.log('Initialisation de l\'application...');
            setDefaultDates();
            updateLastUpdateTime();
            loadFromLocalStorage();
            populateFilters();
            applyFilters();
            updateDataTable();
            updateDataStats();
            setTodayForNewSale();
        }

        // Fonction pour ajouter une vente
        async function addSale() {
            const commercial = document.getElementById('newCommercial').value.trim();
            const client = document.getElementById('newClient').value.trim();
            const date = document.getElementById('newDate').value;
            const invoice = document.getElementById('newInvoice').value.trim();
            const product = document.getElementById('newProduct').value.trim();
            const quantity = parseInt(document.getElementById('newQuantity').value) || 0;
            const format = document.getElementById('newFormat').value.trim();
            const marque = document.getElementById('newMarque').value.trim();
            const valeur = parseInt(document.getElementById('newValue').value) || 0;

            if (!commercial || !client || !date || !product || quantity <= 0 || valeur <= 0) {
                showAlert('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }

            const newSale = {
                commercial: commercial,
                client: client,
                date: new Date(date).toLocaleDateString('fr-FR'),
                product: product,
                invoice: invoice,
                quantity: quantity,
                format: format,
                marque: marque,
                valeur: valeur
            };

            try {
                await db.collection("sales").add(newSale);
                showAlert(`Vente ajoutÃ©e avec succÃ¨s ! Valeur: ${formatCurrency(valeur)}`, 'success');
                clearSaleForm();
            } catch (error) {
                console.error("Erreur lors de l'ajout de la vente: ", error);
                showAlert("Erreur lors de l'ajout de la vente.", 'error');
            }
        }

        // Fonction pour supprimer une vente
        async function deleteSale(id) {
            if (confirm('Supprimer cette vente ?')) {
                try {
                    await db.collection("sales").doc(id).delete();
                    showAlert('Vente supprimÃ©e', 'success');
                } catch (error) {
                    console.error("Erreur lors de la suppression de la vente: ", error);
                    showAlert("Erreur lors de la suppression de la vente.", 'error');
                }
            }
        }

        // Fonctions existantes pour la gestion locale des donnÃ©es
        function loadFromLocalStorage() {
            const localData = localStorage.getItem('kamlacSalesData');
            if (localData) {
                salesData = JSON.parse(localData);
                console.log(`ChargÃ© ${salesData.length} ventes depuis localStorage`);
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('kamlacSalesData', JSON.stringify(salesData));
        }

        // (Le reste de vos fonctions existantes)
    </script>
</body>
</html>
